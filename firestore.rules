
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Secure Match for the Leads Collection
    match /leads/{leadId} {
      
      // 1. ALLOW CREATE: Only if the data passes validation. (Public write access for the form)
      allow create: if isValidLead(request.resource.data);
      
      // 2. DENY READ/UPDATE/DELETE: Only authenticated users (your admin account) can view/manage leads.
      // This fixes the public security hole.
      allow read, update, delete: if request.auth != null; 
    }

    // Validation function - Ensures data integrity and correct fields
    function isValidLead(data) {
      // subject is now a required field for the CV page form
      let requiredKeys = ['id', 'name', 'email', 'subject', 'timestamp'];
      let optionalKeys = ['message'];
      let allKeys = requiredKeys.concat(optionalKeys);

      return data.keys().hasAll(requiredKeys)
          // Ensures only the fields we expect are present (prevents spam/overwrites)
          && data.keys().hasOnly(allKeys) 
          
          // Data type and basic integrity checks
          && data.name is string && data.name.size() > 1
          && data.email is string && data.email.matches('.+@.+\\..+')
          && data.subject is string && data.subject.size() > 1
          && data.timestamp is string
          && data.id is string
          && data.id.size() > 10;
    }
  }
}
